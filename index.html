<!DOCTYPE html>
<html lang="cs" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>LifeXP</title>
    <!-- PWA manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- App icon for homescreen and splash -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
    <meta name="theme-color" content="#0D0F12">
    <meta name="apple-mobile-web-app-title" content="LifeXP">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="LifeXP">
    <meta name="description" content="LifeXP – Sledujte svůj pokrok, úkoly a XP v minimalistické mobilní aplikaci.">
    <!-- Prevent phone number/email detection -->
    <meta name="format-detection" content="telephone=no, email=no">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Lucide Icons for UI -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap');
        
        :root {
            --bg-color: #0D0F12;
            --primary-glow: rgba(199, 172, 255, 0.5);
            --secondary-glow: rgba(107, 33, 168, 0.7);
        }

        html, body {
            font-family: 'Nunito', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: #E5E7EB;
            overscroll-behavior-y: none;
            -webkit-user-select: none; user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 100vh; height: 100dvh;
            overflow: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 15% 25%, var(--primary-glow) 0%, transparent 25%),
                        radial-gradient(circle at 85% 75%, var(--secondary-glow) 0%, transparent 25%);
            opacity: 0.3;
            filter: blur(100px);
            z-index: -1;
            animation: background-pan 25s linear infinite;
        }

        @keyframes background-pan {
            0% { transform: translate(0, 10%) scale(1.2); }
            25% { transform: translate(-5%, -10%) scale(1.3); }
            50% { transform: translate(10%, 5%) scale(1.1); }
            75% { transform: translate(5%, -5%) scale(1.4); }
            100% { transform: translate(0, 10%) scale(1.2); }
        }

        input, button, select, textarea {
            font-family: inherit;
            font-size: 1rem;
        }

        #app {
            height: 100dvh;
            box-sizing: border-box;
        }

        main {
            flex-grow: 1;
            overflow-y: auto;
            height: 1px;
            padding: env(safe-area-inset-top, 16px) env(safe-area-inset-right, 8px) 0 env(safe-area-inset-left, 8px);
        }

        #page-dashboard { height: 100%; overflow: hidden; }

        ::-webkit-scrollbar { display: none; }

        .ui-card {
            background: rgba(28, 29, 40, 0.5);
            border-radius: 1.75rem;
            padding: 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3), 
                        inset 0 1px 1px rgba(255,255,255,0.05);
            backdrop-filter: blur(24px) saturate(150%);
            -webkit-backdrop-filter: blur(24px) saturate(150%);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        #page-dashboard .ui-card {
            animation: card-fade-in 0.6s cubic-bezier(.21,.63,.35,1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        
        .ui-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 150%; height: 150%;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.15) 0%, transparent 40%);
            transform: translate(-25%, -25%) scale(0);
            transition: transform 0.6s cubic-bezier(.21,.63,.35,1);
            opacity: 0;
            pointer-events: none;
        }
        
        .dashboard-card {
            cursor: pointer;
        }

        .dashboard-card:hover {
             border-color: rgba(167, 139, 250, 0.5);
             transform: translateY(-5px) scale(1.02);
             box-shadow: 0 16px 48px rgba(0,0,0,0.4), 0 0 40px var(--primary-glow);
        }
        
        .dashboard-card:hover::before {
            transform: translate(-25%, -25%) scale(1);
            opacity: 1;
        }

        @keyframes card-fade-in {
            to { opacity: 1; transform: translateY(0); }
        }

        .grid { gap: 1rem !important; padding: 1rem 0.5rem !important; }
        
        @media (max-width: 600px) {
            .grid { gap: 0.75rem !important; padding: 0.75rem 0.25rem !important; }
            .ui-card { border-radius: 1.25rem !important; padding: 1rem !important; }
        }

        nav#bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 40;
            width: 100%;
            background: rgba(20, 21, 30, 0.65);
            box-shadow: 0 0 24px rgba(0,0,0,0.5);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem 1.5rem 0 0;
            padding-bottom: env(safe-area-inset-bottom, 12px);
        }

        .nav-item {
            border-radius: 1rem; color: #9CA3AF; font-weight: 600;
            transition: all 0.25s ease;
            position: relative;
        }
        
        .nav-item.active {
            color: #fff !important;
            transform: translateY(-2px);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            top: -5px; 
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 4px;
            background: linear-gradient(90deg, #A78BFA, #C4B5FD);
            border-radius: 2px;
            box-shadow: 0 0 12px #A78BFA;
        }
        
        .nav-item i { transition: color 0.25s ease; }
        .nav-item span { font-size: 0.7rem; margin-top: 0.2rem; letter-spacing: 0.02em; }

        .loader {
            width: 60px; height: 60px;
            border-radius: 50%;
            background: conic-gradient(#A78BFA, #C4B5FD, #A78BFA);
            animation: spin 1s linear infinite;
        }
        .loader::before {
            content: '';
            position: absolute;
            top: 5px; left: 5px; right: 5px; bottom: 5px;
            background: var(--bg-color);
            border-radius: 50%;
        }

        input, select, textarea {
            background: rgba(30, 32, 45, 0.7) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #e5e7eb !important;
            border-radius: 1rem !important;
            padding: 0.9rem 1.1rem !important;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
            transition: all 0.25s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none !important;
            border-color: #A78BFA !important;
            background: rgba(45, 48, 65, 0.8) !important;
            box-shadow: 0 0 15px rgba(167, 139, 250, 0.5), inset 0 1px 2px rgba(0,0,0,0.2);
        }
        
        button.purple-gradient {
            background-image: linear-gradient(to right, #8B5CF6, #6D28D9);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
            border: none !important;
        }
        button.purple-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }
        button.purple-gradient:active {
            transform: translateY(0px) scale(0.98);
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
        }

        .purple-gradient-text {
            background: linear-gradient(to right, #C4B5FD, #A78BFA);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(196, 181, 253, 0.2);
        }

        #confirmation-modal, #info-modal {
            background: rgba(13, 15, 18, 0.5) !important;
            backdrop-filter: blur(16px) saturate(120%);
            -webkit-backdrop-filter: blur(16px) saturate(120%);
            animation: modal-bg-fade-in 0.4s ease forwards;
        }
        
        #confirmation-modal .ui-card, #info-modal .ui-card {
            animation: modal-content-in 0.4s cubic-bezier(.21,.63,.35,1) forwards;
        }
        
        @keyframes modal-bg-fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes modal-content-in {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .page {
            display: none;
            animation: page-fade-out 0.3s ease forwards;
        }
        .page.active {
            display: block;
            animation: page-fade-in 0.5s ease forwards;
        }
        @keyframes page-fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes page-fade-out {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        #page-log, #page-admin {
            padding: 1.1rem !important;
        }
        #page-log h1, #page-admin h1 {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 1.5rem !important;
        }
        #page-log h2, #page-admin h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem !important;
            border-left: 3px solid #A78BFA;
            padding-left: 0.75rem;
        }
        
        #admin-tasks-list > div {
            background: rgba(45,55,72,0.55) !important;
            border-radius: 1.25rem !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            margin-bottom: 0.8rem !important;
            padding: 1rem 1.25rem !important;
            transition: all 0.25s ease;
        }
        
        #admin-tasks-list > div:hover {
            transform: translateX(5px);
            border-color: rgba(167, 139, 250, 0.5) !important;
        }

        .dashboard-card .details-view {
            display: none;
            animation: details-fade-in 0.4s ease forwards;
        }
        .dashboard-card.active .summary-view {
            display: none;
        }
        .dashboard-card.active .details-view {
            display: flex;
        }
        @keyframes details-fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Drag and Drop styles */
        .draggable {
            cursor: grab;
        }
        .dragging {
            opacity: 0.5;
            background: rgba(60, 62, 80, 0.7);
        }

    </style>
</head>
<body class="text-gray-200 antialiased">

    <!-- Main Application Container -->
    <div id="app" class="max-w-lg mx-auto flex flex-col">

        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-[#0D0F12] flex flex-col items-center justify-center z-50">
            <div class="loader"></div>
            <p class="mt-4 text-lg text-gray-400">Načítání dat...</p>
        </div>

        <!-- Login/Register Screen -->
        <div id="auth-screen" class="hidden fixed inset-0 bg-[#0D0F12] flex flex-col items-center justify-center z-40 p-6">
            
            <div id="login-view" class="w-full max-w-sm text-center">
                <h1 class="text-5xl font-extrabold text-white mb-2">Life<span class="purple-gradient-text">XP</span></h1>
                <p class="text-gray-400 mb-8">Vítejte zpět!</p>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" class="w-full" placeholder="E-mail" required autocomplete="username">
                    <div class="relative">
                        <input type="password" id="login-password" class="w-full pr-12" placeholder="Heslo" required autocomplete="current-password">
                        <button type="button" class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-violet-400 transition-colors focus:outline-none" data-target="login-password">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button type="submit" class="w-full purple-gradient text-white font-bold py-3 px-4 rounded-2xl text-lg">
                        Přihlásit se
                    </button>
                </form>
                <div id="login-error" class="text-red-400 text-sm mt-3 min-h-[1.5em]"></div>
                <div class="text-center mt-6 text-sm text-gray-500">
                    <span>Nemáte účet?</span>
                    <a href="#" id="show-register-view" class="font-semibold text-violet-400 hover:underline transition-colors">Zaregistrovat se</a>
                </div>
            </div>

            <div id="register-view" class="hidden w-full max-w-sm text-center">
                <h1 class="text-5xl font-extrabold text-white mb-2">Life<span class="purple-gradient-text">XP</span></h1>
                <p class="text-gray-400 mb-8">Vytvořte si nový účet</p>
                <form id="register-form" class="space-y-4">
                    <input type="email" id="register-email" class="w-full" placeholder="E-mail" required autocomplete="username">
                    <div class="relative">
                        <input type="password" id="register-password" class="w-full pr-12" placeholder="Heslo" required autocomplete="new-password">
                        <button type="button" class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-violet-400 transition-colors focus:outline-none" data-target="register-password">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="relative">
                        <input type="password" id="register-password-confirm" class="w-full pr-12" placeholder="Potvrzení hesla" required autocomplete="new-password">
                        <button type="button" class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-violet-400 transition-colors focus:outline-none" data-target="register-password-confirm">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button type="submit" class="w-full purple-gradient text-white font-bold py-3 px-4 rounded-2xl text-lg">
                        Zaregistrovat se
                    </button>
                </form>
                <div id="register-error" class="text-red-400 text-sm mt-3 min-h-[1.5em]"></div>
                <div class="text-center mt-6 text-sm text-gray-500">
                    <span>Máte již účet?</span>
                    <a href="#" id="show-login-view" class="font-semibold text-violet-400 hover:underline transition-colors">Přihlásit se</a>
                </div>
            </div>
        </div>


        <!-- Main Content Area -->
        <div id="main-content" class="hidden flex-grow w-full flex flex-col">
            <main>
                <div id="page-dashboard" class="page">
                    <div class="grid grid-cols-2 grid-rows-4 gap-4 h-full px-2 pt-2 pb-4">
                        
                        <div class="ui-card col-span-2 flex flex-col justify-center items-center" data-card-type="xp-weekly">
                            <div class="w-full h-full flex flex-col items-center justify-center">
                                <p class="text-sm font-bold self-start mb-1 text-violet-300">XP za posledních 7 dní</p>
                                <div class="flex-grow w-full">
                                    <canvas id="xp-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ui-card dashboard-card flex flex-col items-center justify-center" data-card-type="total-xp">
                            <div class="summary-view w-full h-full flex flex-col items-center justify-center">
                                <p class="text-xs text-gray-400 mb-1">Celkové XP</p>
                                <span id="total-xp-display" class="text-4xl font-extrabold purple-gradient-text flex-grow flex items-center justify-center"></span>
                            </div>
                            <div class="details-view w-full h-full flex-col justify-center text-sm text-left">
                                <h4 class="text-base font-bold mb-2 text-violet-300">XP Statistiky</h4>
                                <p class="flex justify-between"><span>Tento týden:</span> <span id="detail-xp-week" class="font-bold text-right"></span></p>
                                <p class="flex justify-between"><span>Tento měsíc:</span> <span id="detail-xp-month" class="font-bold text-right"></span></p>
                                <p class="flex justify-between"><span>Průměr/den:</span> <span id="detail-xp-avg" class="font-bold text-right"></span></p>
                            </div>
                        </div>

                        <div class="ui-card dashboard-card flex flex-col items-center justify-center" data-card-type="category-radar">
                            <div class="summary-view w-full h-full flex flex-col items-center justify-center">
                                <p class="text-xs text-gray-400 mb-1">Rozložení kategorií</p>
                                <div class="w-full h-full flex-grow flex items-center justify-center">
                                    <canvas id="category-radar-chart" style="max-width:100%;max-height:80px;"></canvas>
                                </div>
                            </div>
                             <div class="details-view w-full h-full flex-col justify-center text-sm text-left">
                                <h4 class="text-base font-bold mb-2 text-violet-300">Top Kategorie</h4>
                                <div id="detail-top-categories" class="space-y-1"></div>
                            </div>
                        </div>
                        
                        <div class="ui-card col-span-2 flex flex-col items-center justify-center" data-card-type="weekly-bar">
                            <div class="w-full h-full flex flex-col items-center justify-center">
                                <p class="text-sm font-bold self-start mb-1 text-violet-300">XP tento týden podle kategorií</p>
                                <div class="flex-grow w-full">
                                    <canvas id="weekly-category-barchart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="ui-card dashboard-card flex flex-col items-center justify-center" data-card-type="weekly-goal">
                            <div class="summary-view w-full h-full flex flex-col items-center justify-center">
                                <p class="text-xs text-gray-400 mb-1">Týdenní cíl</p>
                                <div class="w-full h-full flex-grow relative flex items-center justify-center">
                                    <canvas id="weekly-goal-chart" style="max-width:70px;max-height:70px;"></canvas>
                                    <div id="weekly-goal-text" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                        <span class="text-xl font-bold"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="details-view w-full h-full flex-col justify-center text-sm text-left">
                                <h4 class="text-base font-bold mb-2 text-violet-300">Postup cíle</h4>
                                <p class="flex justify-between"><span>Splněno:</span> <span id="detail-goal-progress" class="font-bold text-right"></span></p>
                                <p class="flex justify-between"><span>Zbývá:</span> <span id="detail-goal-remaining" class="font-bold text-right"></span></p>
                            </div>
                        </div>

                        <div class="ui-card dashboard-card flex flex-col items-center justify-center" data-card-type="best-day">
                            <div class="summary-view w-full h-full flex flex-col items-center justify-center">
                                <p class="text-xs text-gray-400 mb-1">Nejlepší den</p>
                                <span id="best-day-xp" class="text-2xl font-bold flex-grow flex items-center justify-center"></span>
                            </div>
                            <div class="details-view w-full h-full flex-col justify-center text-sm text-left">
                                <h4 class="text-base font-bold mb-2 text-violet-300">Detail nejlepšího dne</h4>
                                <p class="flex justify-between"><span>Datum:</span> <span id="detail-best-day-date" class="font-bold text-right"></span></p>
                                <p class="flex justify-between"><span>Získáno:</span> <span id="detail-best-day-xp" class="font-bold text-right"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-log" class="page">
                    <h1 class="font-bold">Denní záznam</h1>
                    <div class="ui-card mb-6">
                        <label for="log-date" class="block text-sm font-medium text-gray-400 mb-2">Datum záznamu</label>
                        <input type="date" id="log-date" class="w-full">
                    </div>
                    <div class="space-y-6">
                        <div>
                            <h2 class="font-semibold">Dostupné úkoly</h2>
                            <div id="log-tasks-container" class="mt-4 space-y-3"></div>
                        </div>
                        <div>
                            <div id="logged-today-header" class="flex justify-between items-center">
                                 <h2 class="font-semibold">Dnes zaznamenáno</h2>
                                 <!-- Clear button will be injected here by JS -->
                            </div>
                            <div id="logged-today-container" class="mt-4 space-y-3"></div>
                        </div>
                    </div>
                </div>

                <div id="page-admin" class="page">
                    <h1 class="font-bold">Správa</h1>
                    <div class="ui-card mb-6">
                        <h2 class="font-semibold">Upravit Profil</h2>
                        <form id="edit-profile-form" class="space-y-4">
                            <input type="text" id="profile-nickname" placeholder="Vaše přezdívka" class="w-full" required>
                            <button type="submit" class="w-full purple-gradient text-white font-bold py-3 px-4 rounded-lg">Uložit přezdívku</button>
                        </form>
                    </div>
                    <div class="ui-card mb-6">
                        <h2 class="font-semibold">Přidat nový úkol</h2>
                        <form id="add-task-form" class="space-y-4">
                            <input type="text" id="task-name" placeholder="Název úkolu" class="w-full" required>
                            <select id="task-category" class="w-full" required>
                                <option value="Mind">Mind</option>
                                <option value="Body">Body</option>
                                <option value="Work">Work</option>
                                <option value="Social">Social</option>
                                <option value="Extra">Extra</option>
                            </select>
                            <input type="number" id="task-xp" placeholder="XP body (+/-)" class="w-full" required>
                            <input type="number" id="task-goal" placeholder="Týdenní cíl (např. 5)" class="w-full">
                            <button type="submit" class="w-full purple-gradient text-white font-bold py-3 px-4 rounded-lg">Přidat úkol</button>
                        </form>
                    </div>
                    <h2 class="font-semibold mb-4">Seznam úkolů</h2>
                    <div id="admin-tasks-list" class="space-y-3"></div>
                    <div class="mt-10 flex justify-center">
                        <button id="logout-btn" class="w-full max-w-xs bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">
                            <i data-lucide="log-out" class="inline-block align-middle mr-2"></i> Odhlásit se
                        </button>
                    </div>
                </div>

            </main>
            <nav id="bottom-nav">
                <div class="max-w-lg mx-auto flex justify-around items-center px-2 py-2">
                    <a href="#" class="nav-item flex-1 flex flex-col items-center justify-center py-1" data-page="dashboard">
                        <i data-lucide="layout-grid" class="w-6 h-6"></i>
                        <span class="text-xs">Přehled</span>
                    </a>
                    <a href="#" class="nav-item flex-1 flex flex-col items-center justify-center py-1" data-page="log">
                        <i data-lucide="check-square" class="w-6 h-6"></i>
                        <span class="text-xs">Denní</span>
                    </a>
                    <a href="#" class="nav-item flex-1 flex flex-col items-center justify-center py-1" data-page="admin">
                        <i data-lucide="sliders-horizontal" class="w-6 h-6"></i>
                        <span class="text-xs">Správa</span>
                    </a>
                </div>
            </nav>
        </div>
    </div>
    
    <div id="confirmation-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4">
        <div class="ui-card w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Opravdu smazat?</h3>
            <p id="modal-text" class="text-gray-400 mb-6">Tuto akci nelze vrátit zpět.</p>
            <div class="flex gap-4">
                <button id="modal-cancel" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Zrušit</button>
                <button id="modal-confirm" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg">Smazat</button>
            </div>
        </div>
    </div>

    <div id="info-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4">
        <div class="ui-card w-full max-w-md text-center relative">
            <button id="info-modal-close" class="absolute top-4 right-4 text-gray-500 hover:text-white">
                <i data-lucide="x"></i>
            </button>
            <h3 id="info-modal-title" class="text-2xl font-bold mb-4 purple-gradient-text"></h3>
            <p id="info-modal-text" class="text-gray-300 mb-6 whitespace-pre-line leading-relaxed"></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, browserLocalPersistence, setPersistence, getAdditionalUserInfo } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, setDoc, serverTimestamp, writeBatch, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCA4yI3whavL3ig0bXgXEidqe08N_hMcvI",
            authDomain: "lifexp-eaf05.firebaseapp.com",
            projectId: "lifexp-eaf05",
            storageBucket: "lifexp-eaf05.appspot.com",
            messagingSenderId: "1071983930268",
            appId: "1:1071983930268:web:8977284d886c0f5ba03659",
            measurementId: "G-LDFQ52L57B"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let userProfile = {};
        let currentPage = 'dashboard';
        let tasks = [];
        let logs = [];
        let xpChart = null;
        let weeklyGoalChart = null;
        let radarChart = null;
        let weeklyCategoryBarChart = null;
        let confirmCallback = null;

        const pages = {
            dashboard: document.getElementById('page-dashboard'),
            log: document.getElementById('page-log'),
            admin: document.getElementById('page-admin')
        };
        const navItems = document.querySelectorAll('.nav-item');
        const logDateInput = document.getElementById('log-date');
        const confirmationModal = document.getElementById('confirmation-modal');
        const infoModal = document.getElementById('info-modal');

        const categoryColors = {
            Mind: '#34D399', Body: '#F87171', Work: '#60A5FA', Social: '#FBBF24', Extra: '#A78BFA',
        };
        const categoryIcons = {
            Mind: '<i data-lucide="brain-circuit" class="w-6 h-6"></i>', Body: '<i data-lucide="heart-pulse" class="w-6 h-6"></i>', Work: '<i data-lucide="briefcase" class="w-6 h-6"></i>', Social: '<i data-lucide="users" class="w-6 h-6"></i>', Extra: '<i data-lucide="star" class="w-6 h-6"></i>',
        };

        function adjustLayout() {
            const nav = document.getElementById('bottom-nav');
            const main = document.querySelector('main');
            if (nav && main) {
                const navHeight = nav.offsetHeight;
                main.style.paddingBottom = `${navHeight}px`;
            }
        }

        setPersistence(auth, browserLocalPersistence).catch((err) => {
            console.error("Chyba při nastavování persistence:", err);
        });

        onAuthStateChanged(auth, user => {
            const loadingScreen = document.getElementById('loading-screen');
            const authScreen = document.getElementById('auth-screen');
            const mainContent = document.getElementById('main-content');
            
            if (user) {
                userId = user.uid;
                authScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                loadingScreen.classList.add('hidden');
                initializeAppState();
            } else {
                userId = null;
                loadingScreen.classList.add('hidden');
                authScreen.classList.remove('hidden');
                mainContent.classList.add('hidden');
            }
        });

        function clearAuthErrors() {
            document.getElementById('login-error').textContent = '';
            document.getElementById('register-error').textContent = '';
            document.querySelectorAll('#auth-screen input').forEach(el => el.classList.remove('input-error'));
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAuthErrors();
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            const errorDiv = document.getElementById('login-error');
            
            try {
                await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
            } catch (err) {
                errorDiv.textContent = 'Přihlášení se nezdařilo. Zkontrolujte e-mail a heslo.';
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAuthErrors();
            const emailInput = document.getElementById('register-email');
            const passwordInput = document.getElementById('register-password');
            const confirmPasswordInput = document.getElementById('register-password-confirm');
            const errorDiv = document.getElementById('register-error');

            if (passwordInput.value !== confirmPasswordInput.value) {
                errorDiv.textContent = 'Hesla se neshodují.';
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
                const additionalInfo = getAdditionalUserInfo(userCredential);
                if (additionalInfo.isNewUser) {
                    setTimeout(showInstallPrompt, 1500);
                }
            } catch (err) {
                let msg = 'Registrace se nezdařila.';
                if (err.code === 'auth/email-already-in-use') msg = 'Tento e-mail je již registrován.';
                else if (err.code === 'auth/weak-password') msg = 'Heslo musí mít alespoň 6 znaků.';
                errorDiv.textContent = msg;
            }
        });
        
        document.getElementById('show-register-view').addEventListener('click', (e) => {
            e.preventDefault();
            clearAuthErrors();
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('register-view').classList.remove('hidden');
        });

        document.getElementById('show-login-view').addEventListener('click', (e) => {
            e.preventDefault();
            clearAuthErrors();
            document.getElementById('register-view').classList.add('hidden');
            document.getElementById('login-view').classList.remove('hidden');
        });

        document.querySelectorAll('.password-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                const targetId = toggle.dataset.target;
                const passwordInput = document.getElementById(targetId);
                if (passwordInput) {
                    const isPassword = passwordInput.type === 'password';
                    passwordInput.type = isPassword ? 'text' : 'password';
                    toggle.innerHTML = `<i data-lucide="${isPassword ? 'eye-off' : 'eye'}" class="w-5 h-5"></i>`;
                    if (window.lucide) window.lucide.createIcons();
                }
            });
        });

        function initializeAppState() {
            lucide.createIcons();
            setupEventListeners();
            navigateTo('dashboard');
            logDateInput.value = new Date().toISOString().split('T')[0];
            listenForProfile();
            listenForTasks();
            listenForLogs();
            checkWeeklySummary();
            adjustLayout();
            window.addEventListener('resize', adjustLayout);
        }

        function navigateTo(pageId) {
            if (currentPage === pageId && pages[pageId]?.classList.contains('active')) return;
            
            currentPage = pageId;
            renderPageContent(); // Render content BEFORE making the page visible.

            Object.values(pages).forEach(p => p.classList.remove('active'));
            if (pages[pageId]) {
                requestAnimationFrame(() => {
                    pages[pageId].classList.add('active');
                });
            }
            
            navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
            document.querySelector('main').style.overflowY = pageId === 'dashboard' ? 'hidden' : 'auto';
        }

        function listenForProfile() {
            if(!userId) return;
            const profileDocRef = doc(db, 'users', userId, 'profile', 'data');
            onSnapshot(profileDocRef, (docSnap) => {
                userProfile = docSnap.exists() ? docSnap.data() : { nickname: 'Nováček', lastWeeklySummary: '' };
                if (!docSnap.exists()) setDoc(profileDocRef, userProfile);
                document.getElementById('profile-nickname').value = userProfile.nickname || '';
            });
        }

        function listenForTasks() {
            if (!userId) return;
            const tasksCollection = collection(db, 'users', userId, 'tasks');
            onSnapshot(tasksCollection, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                tasks.sort((a, b) => (a.order ?? Infinity) - (b.order ?? Infinity));
                renderPageContent();
            });
        }

        function listenForLogs() {
            if (!userId) return;
            const logsCollection = collection(db, 'users', userId, 'logs');
            onSnapshot(logsCollection, (snapshot) => {
                logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPageContent();
            });
        }

        function renderPageContent() {
            if (!userId) return;
            switch (currentPage) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'log':
                    renderLogPage();
                    break;
                case 'admin':
                    renderAdminPage();
                    break;
            }
            lucide.createIcons();
        }
        
        function renderDashboard() {
            renderDashboardSummaries();
            renderDashboardDetails();
        }

        function renderDashboardSummaries() {
            const totalXp = logs.reduce((sum, log) => sum + log.xp, 0);
            animateValue(document.getElementById('total-xp-display'), 0, totalXp, 600);
            
            const dailyXp = logs.reduce((acc, log) => {
                acc[log.date] = (acc[log.date] || 0) + log.xp;
                return acc;
            }, {});
            let bestDay = { date: '-', xp: 0 };
            Object.entries(dailyXp).forEach(([date, xp]) => {
                if (xp > bestDay.xp) bestDay = { date, xp };
            });
            document.getElementById('best-day-xp').textContent = bestDay.xp > 0 ? `${bestDay.xp} XP` : 'Žádná data';

            renderXpChart();
            renderWeeklyGoalChart();
            renderCategoryRadarChart();
            renderWeeklyCategoryBarChart();
        }

        function renderDashboardDetails() {
            // Total XP Details
            const { start: weekStart } = getWeekDateRange(new Date());
            const weekStartString = weekStart.toISOString().split('T')[0];
            const monthStartString = new Date(new Date().setDate(1)).toISOString().split('T')[0];
            
            const xpThisWeek = logs.filter(l => l.date >= weekStartString).reduce((sum, l) => sum + l.xp, 0);
            const xpThisMonth = logs.filter(l => l.date >= monthStartString).reduce((sum, l) => sum + l.xp, 0);
            const totalDays = logs.length > 0 ? (new Date() - new Date(logs[0].date)) / (1000 * 3600 * 24) + 1 : 1;
            const avgXp = (logs.reduce((sum, l) => sum + l.xp, 0) / Math.max(1, totalDays)).toFixed(1);

            document.getElementById('detail-xp-week').textContent = `${xpThisWeek} XP`;
            document.getElementById('detail-xp-month').textContent = `${xpThisMonth} XP`;
            document.getElementById('detail-xp-avg').textContent = `${avgXp} XP`;

            // Top Categories Details
            const categoryXP = logs.reduce((acc, log) => {
                if (log.xp > 0) acc[log.category] = (acc[log.category] || 0) + log.xp;
                return acc;
            }, {});
            const topCategories = Object.entries(categoryXP).sort((a, b) => b[1] - a[1]).slice(0, 3);
            const topCategoriesEl = document.getElementById('detail-top-categories');
            topCategoriesEl.innerHTML = topCategories.map(([cat, xp]) => 
                `<p class="flex justify-between">
                    <span style="color:${categoryColors[cat]}">${cat}</span>
                    <span class="font-bold">${xp} XP</span>
                </p>`
            ).join('') || '<p class="text-gray-400">Žádná data</p>';

            // Weekly Goal Details
            const tasksWithGoals = tasks.filter(t => t.goalFrequency > 0);
            const totalGoal = tasksWithGoals.reduce((sum, t) => sum + t.goalFrequency, 0);
            const thisWeekLogs = logs.filter(l => {
                const task = tasks.find(t => t.id === l.taskId);
                return l.date >= weekStartString && task && task.goalFrequency > 0;
            });
            const completedCount = thisWeekLogs.length;
            document.getElementById('detail-goal-progress').textContent = `${completedCount} / ${totalGoal}`;
            document.getElementById('detail-goal-remaining').textContent = `${Math.max(0, totalGoal - completedCount)}`;

            // Best Day Details
            const dailyXp = logs.reduce((acc, log) => {
                acc[log.date] = (acc[log.date] || 0) + log.xp;
                return acc;
            }, {});
            let bestDay = { date: '-', xp: 0 };
            Object.entries(dailyXp).forEach(([date, xp]) => {
                if (xp > bestDay.xp) bestDay = { date, xp };
            });
            document.getElementById('detail-best-day-date').textContent = bestDay.date === '-' ? '-' : new Date(bestDay.date).toLocaleDateString('cs-CZ');
            document.getElementById('detail-best-day-xp').textContent = `${bestDay.xp} XP`;
        }

        function renderCategoryRadarChart() {
            const ctx = document.getElementById('category-radar-chart').getContext('2d');
            const data = Object.keys(categoryColors).map(cat =>
                logs.filter(l => l.category === cat && l.xp > 0).reduce((sum, l) => sum + l.xp, 0)
            );
            if (radarChart) radarChart.destroy();
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: { labels: Object.keys(categoryColors), datasets: [{ data, backgroundColor: 'rgba(167,139,250,0.25)', borderColor: '#A78BFA', borderWidth: 2 }] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }, 
                    scales: { 
                        r: { 
                            display: true,
                            pointLabels: {
                                color: '#C4B5FD',
                                font: { size: 10, weight: 'bold' }
                            },
                            angleLines: { color: 'rgba(255,255,255,0.1)' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { display: false, backdropColor: 'transparent' }
                        } 
                    } 
                }
            });
        }

        function renderWeeklyGoalChart() {
            const ctx = document.getElementById('weekly-goal-chart').getContext('2d');
            const tasksWithGoals = tasks.filter(t => t.goalFrequency > 0);
            const textEl = document.getElementById('weekly-goal-text').firstElementChild;
            if (tasksWithGoals.length === 0) {
                textEl.textContent = 'N/A';
                if (weeklyGoalChart) weeklyGoalChart.destroy();
                return;
            }
            const totalGoal = tasksWithGoals.reduce((sum, t) => sum + t.goalFrequency, 0);
            const { start } = getWeekDateRange(new Date());
            const startOfWeekString = start.toISOString().split('T')[0];
            const thisWeekLogs = logs.filter(l => l.date >= startOfWeekString && tasks.find(t => t.id === l.taskId)?.goalFrequency > 0);
            const completedCount = thisWeekLogs.length;
            const percentage = totalGoal > 0 ? Math.min(100, Math.round((completedCount / totalGoal) * 100)) : 0;
            textEl.textContent = `${percentage}%`;

            if (weeklyGoalChart) weeklyGoalChart.destroy();
            weeklyGoalChart = new Chart(ctx, {
                type: 'doughnut',
                data: { datasets: [{ data: [completedCount, Math.max(0, totalGoal - completedCount)], backgroundColor: ['#A78BFA', 'rgba(255,255,255,0.1)'], borderWidth: 0, borderRadius: 8, cutout: '80%' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });
        }

        function renderXpChart() {
            const ctx = document.getElementById('xp-chart').getContext('2d');
            const dayLabels = ['Po', 'Út', 'St', 'Čt', 'Pá', 'So', 'Ne'];
            const labels = [...Array(7)].map((_, i) => new Date(new Date().setDate(new Date().getDate() - (6 - i))).toISOString().split('T')[0]);
            const data = labels.map(dateString => logs.filter(log => log.date === dateString).reduce((sum, log) => sum + log.xp, 0));
            
            if (xpChart) xpChart.destroy();
            xpChart = new Chart(ctx, {
                type: 'line',
                data: { labels: dayLabels, datasets: [{ label: 'XP', data, borderColor: '#A78BFA', tension: 0.4, pointBackgroundColor: '#fff', pointBorderColor: '#A78BFA' }] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { display: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#9CA3AF' } }, 
                        y: { display: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#9CA3AF' } } 
                    } 
                }
            });
        }

        function renderWeeklyCategoryBarChart() {
            const ctx = document.getElementById('weekly-category-barchart').getContext('2d');
            const { start } = getWeekDateRange(new Date());
            const startOfWeekString = start.toISOString().split('T')[0];
            const thisWeekLogs = logs.filter(l => l.date >= startOfWeekString && l.xp > 0);
            const data = Object.keys(categoryColors).map(cat => thisWeekLogs.filter(l => l.category === cat).reduce((sum, l) => sum + l.xp, 0));
            const labels = Object.keys(categoryColors);
            
            if (weeklyCategoryBarChart) weeklyCategoryBarChart.destroy();
            weeklyCategoryBarChart = new Chart(ctx, { 
                type: 'bar',
                data: { labels, datasets: [{ data, backgroundColor: Object.values(categoryColors), borderRadius: 4 }] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    indexAxis: 'y', 
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#9CA3AF' } }, 
                        y: { grid: { display: false }, ticks: { color: '#9CA3AF' } } 
                    }
                } 
            });
        }
        
        function renderLogPage() {
            const selectedDate = logDateInput.value;
            const tasksContainer = document.getElementById('log-tasks-container');
            const loggedTodayContainer = document.getElementById('logged-today-container');
            const loggedTodayHeader = document.getElementById('logged-today-header');
            
            tasksContainer.innerHTML = '';
            loggedTodayContainer.innerHTML = '';
            
            const existingClearBtn = loggedTodayHeader.querySelector('.clear-day-btn');
            if(existingClearBtn) existingClearBtn.remove();

            const loggedTaskIdsForDate = logs.filter(l => l.date === selectedDate).map(l => l.taskId);

            tasks.forEach(task => {
                const isLogged = loggedTaskIdsForDate.includes(task.id);
                const taskEl = document.createElement('div');
                taskEl.className = 'flex items-center justify-between p-3 rounded-2xl bg-gray-800/50 border border-gray-700/50 draggable';
                taskEl.setAttribute('draggable', 'true');
                taskEl.dataset.taskId = task.id;

                taskEl.innerHTML = `
                    <div class="flex items-center gap-4 flex-grow">
                        <i data-lucide="grip-vertical" class="cursor-grab text-gray-500"></i>
                        <div style="color: ${categoryColors[task.category]}">${categoryIcons[task.category]}</div>
                        <p class="font-semibold text-white flex-grow">${task.name}</p>
                        <p class="text-sm font-semibold w-20 text-right ${task.xp > 0 ? 'text-green-400' : 'text-red-400'}">${task.xp > 0 ? '+' : ''}${task.xp} XP</p>
                    </div>
                    <button data-task-id="${task.id}" class="log-task-btn p-2 rounded-full ${isLogged ? 'bg-gray-600' : 'purple-gradient'} ml-2">
                        <i data-lucide="${isLogged ? 'rotate-ccw' : 'plus'}" class="w-6 h-6 text-white"></i>
                    </button>
                `;
                tasksContainer.appendChild(taskEl);
            });

            const logsForDate = logs.filter(l => l.date === selectedDate);
            if (logsForDate.length === 0) {
                loggedTodayContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Dnes zatím žádné záznamy.</p>';
            } else {
                const clearButton = document.createElement('button');
                clearButton.className = 'clear-day-btn text-red-400 hover:text-red-300 text-sm font-semibold flex items-center gap-1';
                clearButton.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i> Vymazat vše';
                loggedTodayHeader.appendChild(clearButton);

                logsForDate.forEach(log => {
                    const task = tasks.find(t => t.id === log.taskId);
                    const logEl = document.createElement('div');
                    logEl.className = 'flex items-center justify-between p-3 rounded-2xl bg-gray-800/50 border border-gray-700/50';
                    logEl.innerHTML = `<div class="flex items-center gap-4"><div style="color: ${task ? categoryColors[task.category] : '#9CA3AF'}">${task ? categoryIcons[task.category] : '<i data-lucide="help-circle" class="w-6 h-6"></i>'}</div><p>${task ? task.name : 'Smazaný úkol'}</p></div><span class="font-bold ${log.xp > 0 ? 'text-green-400' : 'text-red-400'}">${log.xp > 0 ? '+' : ''}${log.xp} XP</span>`;
                    loggedTodayContainer.appendChild(logEl);
                });
            }
             lucide.createIcons();
        }

        function renderAdminPage() {
            const tasksList = document.getElementById('admin-tasks-list');
            tasksList.innerHTML = '';
            if (tasks.length === 0) {
                tasksList.innerHTML = '<p class="text-gray-500 text-center py-4">Zatím nebyly přidány žádné úkoly.</p>';
                return;
            }
            tasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.innerHTML = `<div class="flex items-center gap-3"><div style="color: ${categoryColors[task.category]}">${categoryIcons[task.category]}</div><div><p class="font-semibold">${task.name}</p><p class="text-sm text-gray-400">Cíl: ${task.goalFrequency > 0 ? `${task.goalFrequency}x týdně` : 'Není'}</p></div></div><div class="flex items-center gap-2"><span class="font-bold ${task.xp > 0 ? 'text-green-400' : 'text-red-400'}">${task.xp > 0 ? '+' : ''}${task.xp} XP</span><button data-task-id="${task.id}" class="delete-task-btn p-2 text-gray-400 hover:text-red-400"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`;
                tasksList.appendChild(taskEl);
            });
        }

        function setupEventListeners() {
            navItems.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); navigateTo(item.dataset.page); }));
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('add-task-form').addEventListener('submit', handleAddTask);
            document.getElementById('edit-profile-form').addEventListener('submit', handleEditProfile);
            
            document.getElementById('admin-tasks-list').addEventListener('click', e => {
                const btn = e.target.closest('.delete-task-btn');
                if (btn) showConfirmationModal('Smazat úkol?', 'Opravdu chcete smazat tento úkol a všechny jeho záznamy?', () => handleDeleteTask(btn.dataset.taskId));
            });

            logDateInput.addEventListener('change', renderLogPage);

            const tasksContainer = document.getElementById('log-tasks-container');
            tasksContainer.addEventListener('click', async e => {
                const button = e.target.closest('.log-task-btn');
                if (button) {
                    const taskId = button.dataset.taskId;
                    const selectedDate = logDateInput.value;
                    const existingLog = logs.find(l => l.date === selectedDate && l.taskId === taskId);
                    if (existingLog) await deleteDoc(doc(db, 'users', userId, 'logs', existingLog.id));
                    else {
                        const task = tasks.find(t => t.id === taskId);
                        if (task) await addDoc(collection(db, 'users', userId, 'logs'), { taskId: task.id, date: selectedDate, xp: task.xp, category: task.category, timestamp: serverTimestamp() });
                    }
                }
            });

            // --- Drag and Drop Logic for Task Reordering ---
            let draggedItem = null;

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            tasksContainer.addEventListener('dragstart', e => {
                draggedItem = e.target;
                setTimeout(() => draggedItem.classList.add('dragging'), 0);
            });

            tasksContainer.addEventListener('dragend', () => {
                if(draggedItem) {
                    draggedItem.classList.remove('dragging');
                    updateTaskOrder();
                    draggedItem = null;
                }
            });

            tasksContainer.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(tasksContainer, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (dragging) {
                    if (afterElement == null) {
                        tasksContainer.appendChild(dragging);
                    } else {
                        tasksContainer.insertBefore(dragging, afterElement);
                    }
                }
            });

            document.getElementById('page-log').addEventListener('click', e => {
                const clearBtn = e.target.closest('.clear-day-btn');
                if (clearBtn) {
                    showConfirmationModal('Smazat všechny záznamy?', `Opravdu chcete smazat všechny záznamy pro datum ${new Date(logDateInput.value).toLocaleDateString('cs-CZ')}?`, handleClearDayLogs);
                }
            });

            document.getElementById('page-dashboard').addEventListener('click', (e) => {
                const clickedCard = e.target.closest('.dashboard-card');
                if (!clickedCard) return;
                const allCards = document.querySelectorAll('#page-dashboard .dashboard-card');
                const wasActive = clickedCard.classList.contains('active');
                allCards.forEach(card => card.classList.remove('active'));
                if (!wasActive) clickedCard.classList.add('active');
            });

            document.getElementById('modal-cancel').addEventListener('click', hideConfirmationModal);
            document.getElementById('info-modal-close').addEventListener('click', hideInfoModal);
            document.getElementById('modal-confirm').addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                hideConfirmationModal();
            });
        }
        
        async function handleAddTask(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#task-name').value.trim();
            const category = form.querySelector('#task-category').value;
            const xp = parseInt(form.querySelector('#task-xp').value, 10);
            const goalFrequency = parseInt(form.querySelector('#task-goal').value, 10) || 0;
            if (name && !isNaN(xp)) {
                await addDoc(collection(db, 'users', userId, 'tasks'), { name, category, xp, goalFrequency, order: tasks.length, createdAt: serverTimestamp() });
                form.reset();
            }
        }

        async function updateTaskOrder() {
            const taskElements = [...document.getElementById('log-tasks-container').children];
            const batch = writeBatch(db);
            taskElements.forEach((el, index) => {
                const taskId = el.dataset.taskId;
                const taskRef = doc(db, 'users', userId, 'tasks', taskId);
                batch.update(taskRef, { order: index });
            });
            await batch.commit();
        }

        async function handleEditProfile(e) {
            e.preventDefault();
            const nickname = document.getElementById('profile-nickname').value.trim();
            if (nickname) {
                await setDoc(doc(db, 'users', userId, 'profile', 'data'), { nickname }, { merge: true });
                showInfoModal('Profil uložen', 'Vaše přezdívka byla úspěšně aktualizována.');
            }
        }

        async function handleDeleteTask(taskId) {
            if (!userId || !taskId) return;
            const batch = writeBatch(db);
            batch.delete(doc(db, 'users', userId, 'tasks', taskId));
            const logsSnapshot = await getDocs(query(collection(db, 'users', userId, 'logs'), where("taskId", "==", taskId)));
            logsSnapshot.forEach(logDoc => batch.delete(logDoc.ref));
            await batch.commit();
        }

        async function handleClearDayLogs() {
            const selectedDate = logDateInput.value;
            const logsToDelete = logs.filter(l => l.date === selectedDate);
            if (logsToDelete.length === 0) return;

            const batch = writeBatch(db);
            logsToDelete.forEach(log => {
                const logRef = doc(db, 'users', userId, 'logs', log.id);
                batch.delete(logRef);
            });
            await batch.commit();
        }

        function showConfirmationModal(title, text, callback) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            confirmCallback = callback;
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        }

        function showInfoModal(title, text) {
            document.getElementById('info-modal-title').textContent = title;
            document.getElementById('info-modal-text').textContent = text;
            infoModal.classList.remove('hidden');
        }

        function hideInfoModal() {
            infoModal.classList.add('hidden');
        }

        function showInstallPrompt() {
            showInfoModal('Přidejte si LifeXP na plochu', 'Pro nejlepší zážitek si aplikaci přidejte na plochu.\n\nPostup:\n1. V prohlížeči klepněte na Sdílet.\n2. Vyberte "Přidat na plochu".');
        }

        function getWeekDateRange(date) {
            const start = new Date(date);
            start.setDate(start.getDate() - start.getDay() + (start.getDay() === 0 ? -6 : 1));
            start.setHours(0, 0, 0, 0);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            end.setHours(23, 59, 59, 999);
            return { start, end };
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString('cs-CZ');
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        async function checkWeeklySummary() {
            if (new Date().getDay() !== 1) return;
            const { start } = getWeekDateRange(new Date());
            const weekId = `${start.getFullYear()}-${start.getMonth()}-${start.getDate()}`;
            if (userProfile.lastWeeklySummary === weekId) return;

            const lastWeek = new Date();
            lastWeek.setDate(lastWeek.getDate() - 7);
            const { start: lastWeekStart, end: lastWeekEnd } = getWeekDateRange(lastWeek);
            const lastWeekLogs = logs.filter(l => l.date >= lastWeekStart.toISOString().split('T')[0] && l.date <= lastWeekEnd.toISOString().split('T')[0]);
            
            if (lastWeekLogs.length > 0) {
                const totalXp = lastWeekLogs.reduce((sum, l) => sum + l.xp, 0);
                const tasksCompleted = lastWeekLogs.length;
                const categories = [...new Set(lastWeekLogs.map(l => l.category))].join(', ');
                showInfoModal('Týdenní shrnutí', `Minulý týden jsi získal(a) ${totalXp} XP!\nDokončil(a) jsi ${tasksCompleted} úkolů.\nNejvíce jsi se zaměřil(a) na kategorie: ${categories}.\n\nJen tak dál!`);
            }
            await setDoc(doc(db, 'users', userId, 'profile', 'data'), { lastWeeklySummary: weekId }, { merge: true });
        }
        
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('SW registered:', reg))
                    .catch(err => console.error('SW registration failed:', err));
            });
        }
    </script>

</body>
</html>
