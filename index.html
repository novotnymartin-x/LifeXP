<!DOCTYPE html>
<html lang="cs" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>LifeXP</title>
    <!-- PWA manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- App icon for homescreen and splash -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
    <meta name="theme-color" content="#0D0F12">
    <meta name="apple-mobile-web-app-title" content="LifeXP">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="LifeXP">
    <meta name="description" content="LifeXP – Sledujte svůj pokrok, úkoly a XP v minimalistické mobilní aplikaci.">
    <!-- Hide browser UI on iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, minimal-ui">
    <!-- Prevent phone number/email detection -->
    <meta name="format-detection" content="telephone=no, email=no">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Lucide Icons for UI -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap');
        html, body {
            font-family: 'Nunito', system-ui, sans-serif;
            background-color: #0D0F12;
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 100vh;
            height: 100dvh;
        }
        body {
            margin: 0;
            padding: 0;
            min-height: 100dvh;
            height: 100dvh;
            overflow: hidden; /* Prevent scrolling on body */
        }
        body::-webkit-scrollbar { display: none; }
        input, button, select, textarea {
            font-family: inherit;
            font-size: 1rem;
        }
        /* Prevent text selection on tap */
        *:not(input):not(textarea) {
            -webkit-user-select: none;
            user-select: none;
        }
        
        #app {
            padding-top: env(safe-area-inset-top);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            height: 100dvh;
        }

        /* Ensure the main content area can scroll on other pages if needed, but not the dashboard */
        main {
            flex-grow: 1;
            overflow-y: auto;
            height: 1px; /* Fix for flex-grow in some browsers */
        }
        
        #page-dashboard {
            height: 100%;
            overflow: hidden;
        }

        /* Custom scrollbar for a sleeker look */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0D0F12; }
        ::-webkit-scrollbar-thumb { background: #2D3748; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4A5568; }

        /* Styles for the navigation bar */
        .nav-item.active svg { color: #A78BFA; }
        .nav-item.active {
            background-color: rgba(167, 139, 250, 0.1);
        }
        
        /* Loading spinner */
        .loader {
            border: 4px solid #4A5568;
            border-top: 4px solid #A78BFA;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom gradient for buttons and charts */
        .purple-gradient {
            background-image: linear-gradient(to right, #8B5CF6, #6D28D9);
        }
        .purple-gradient-text {
            background: linear-gradient(to right, #A78BFA, #C4B5FD);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Base styles for UI cards */
        .ui-card {
            background-color: #1A1C20;
            border-radius: 1.25rem; /* 20px */
            padding: 1rem; /* 16px */
            border: 1px solid #2D3748;
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
            display: flex;
            flex-direction: column;
            margin: 0 !important;
            box-shadow: 0 2px 16px 0 #00000014;
            /* Modern shadow for floating effect */
        }
        
        /* Animation for cards */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .ui-card:hover {
            transform: translateY(-2px);
            transition: transform 0.2s ease-in-out;
        }

        /* Shake animation for error feedback */
        .shake {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translateX(-2px);}
            20%, 80% { transform: translateX(4px);}
            30%, 50%, 70% { transform: translateX(-6px);}
            40%, 60% { transform: translateX(6px);}
        }
        
        /* Styling for input fields with errors */
        .input-error {
            box-shadow: 0 0 0 2px #ef4444 !important;
            background: rgba(239,68,68,0.08) !important;
            transition: box-shadow 0.2s, background 0.2s;
        }
        nav {
            box-shadow: 0 0 16px 0 #00000033;
            /* Modern floating effect */
        }
        .nav-item {
            border-radius: 1rem;
            min-width: 0;
            flex-basis: 0;
            flex-grow: 1;
            color: #9CA3AF;
            font-weight: 500;
            transition: background 0.18s, color 0.18s;
        }
        .nav-item.active, .nav-item:active {
            background: linear-gradient(90deg, #8B5CF6 0%, #6D28D9 100%);
            color: #fff !important;
        }
        .nav-item.active i, .nav-item.active span {
            color: #fff !important;
        }
        .nav-item i {
            display: block;
            margin: 0 auto;
            color: inherit;
        }
        .nav-item span {
            font-size: 0.75rem;
            color: inherit;
            margin-top: 0.1rem;
            font-weight: 600;
            letter-spacing: 0.01em;
        }
        @media (max-width: 600px) {
            nav {
                max-width: 100vw;
                left: 0;
                right: 0;
                border-radius: 1.25rem 1.25rem 0 0;
            }
        }
        .ui-card {
            /* ...existing code... */
            margin: 0 !important;
            box-shadow: 0 2px 16px 0 #00000014;
            /* Modern shadow for floating effect */
        }
        .grid {
            gap: 1rem !important; /* 16px mezera mezi dlaždicemi */
        }
        @media (max-width: 600px) {
            .grid {
                gap: 0.75rem !important; /* 12px mezera na menších displejích */
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            .ui-card {
                border-radius: 1rem !important;
            }
        }
    </style>
</head>
<body class="text-gray-200 antialiased bg-[#0D0F12]">

    <!-- Main Application Container -->
    <div id="app" class="max-w-lg mx-auto flex flex-col">

        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-[#0D0F12] flex flex-col items-center justify-center z-50">
            <div class="loader"></div>
            <p class="mt-4 text-lg text-gray-400">Načítání dat...</p>
        </div>

        <!-- Login/Register Screen -->
        <div id="auth-screen" class="hidden fixed inset-0 bg-[#0D0F12] flex flex-col items-center justify-center z-40 p-6">
            
            <!-- Login View -->
            <div id="login-view" class="w-full max-w-sm text-center">
                <h1 class="text-5xl font-extrabold text-white mb-2">Life<span class="purple-gradient-text">XP</span></h1>
                <p class="text-gray-400 mb-8">Vítejte zpět!</p>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" class="w-full bg-[#1A1C20] border border-gray-700 rounded-xl p-3 text-white placeholder-gray-500 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 outline-none transition-all duration-200" placeholder="E-mail" required autocomplete="username">
                    <div class="relative">
                        <input type="password" id="login-password" class="w-full bg-[#1A1C20] border border-gray-700 rounded-xl p-3 text-white placeholder-gray-500 pr-12 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 outline-none transition-all duration-200" placeholder="Heslo" required autocomplete="current-password">
                        <button type="button" class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-violet-400 transition-colors focus:outline-none" data-target="login-password">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button type="submit" class="w-full purple-gradient text-white font-bold py-3 px-4 rounded-2xl text-lg hover:opacity-90 transition-opacity duration-300 shadow-lg shadow-purple-500/20">
                        Přihlásit se
                    </button>
                </form>
                <div id="login-error" class="text-red-400 text-sm mt-3 min-h-[1.5em]"></div>
                <div class="text-center mt-6 text-sm text-gray-500">
                    <span>Nemáte účet?</span>
                    <a href="#" id="show-register-view" class="font-semibold text-violet-400 hover:underline transition-colors">Zaregistrovat se</a>
                </div>
            </div>

            <!-- Registration View (hidden by default) -->
            <div id="register-view" class="hidden w-full max-w-sm text-center">
                <h1 class="text-5xl font-extrabold text-white mb-2">Life<span class="purple-gradient-text">XP</span></h1>
                <p class="text-gray-400 mb-8">Vytvořte si nový účet</p>
                <form id="register-form" class="space-y-4">
                    <input type="email" id="register-email" class="w-full bg-[#1A1C20] border border-gray-700 rounded-xl p-3 text-white placeholder-gray-500 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 outline-none transition-all duration-200" placeholder="E-mail" required autocomplete="username">
                    <div class="relative">
                        <input type="password" id="register-password" class="w-full bg-[#1A1C20] border border-gray-700 rounded-xl p-3 text-white placeholder-gray-500 pr-12 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 outline-none transition-all duration-200" placeholder="Heslo" required autocomplete="new-password">
                        <button type="button" class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-violet-400 transition-colors focus:outline-none" data-target="register-password">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="relative">
                        <input type="password" id="register-password-confirm" class="w-full bg-[#1A1C20] border border-gray-700 rounded-xl p-3 text-white placeholder-gray-500 pr-12 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 outline-none transition-all duration-200" placeholder="Potvrzení hesla" required autocomplete="new-password">
                        <button type="button" class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-violet-400 transition-colors focus:outline-none" data-target="register-password-confirm">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button type="submit" class="w-full purple-gradient text-white font-bold py-3 px-4 rounded-2xl text-lg hover:opacity-90 transition-opacity duration-300 shadow-lg shadow-purple-500/20">
                        Zaregistrovat se
                    </button>
                </form>
                <div id="register-error" class="text-red-400 text-sm mt-3 min-h-[1.5em]"></div>
                <div class="text-center mt-6 text-sm text-gray-500">
                    <span>Máte již účet?</span>
                    <a href="#" id="show-login-view" class="font-semibold text-violet-400 hover:underline transition-colors">Přihlásit se</a>
                </div>
            </div>
        </div>


        <!-- Main Content Area -->
        <div id="main-content" class="hidden flex-grow w-full flex flex-col">
            <!-- Top Navigation Bar -->
            <nav class="fixed bottom-0 left-0 right-0 z-40 w-full max-w-lg mx-auto bg-[#181924] border-t border-[#23243a] flex justify-between items-center px-2 py-1"
                 style="height: 60px; border-radius: 1.25rem 1.25rem 0 0;">
                <a href="#" class="nav-item flex-1 flex flex-col items-center justify-center py-1 transition-colors duration-200" data-page="dashboard">
                    <i data-lucide="home" class="w-7 h-7"></i>
                    <span class="text-xs mt-1">Přehled</span>
                </a>
                <a href="#" class="nav-item flex-1 flex flex-col items-center justify-center py-1 transition-colors duration-200" data-page="log">
                    <i data-lucide="check-square" class="w-7 h-7"></i>
                    <span class="text-xs mt-1">Denní</span>
                </a>
                <a href="#" class="nav-item flex-1 flex flex-col items-center justify-center py-1 transition-colors duration-200" data-page="stats">
                    <i data-lucide="bar-chart-3" class="w-7 h-7"></i>
                    <span class="text-xs mt-1">Statistiky</span>
                </a>
                <a href="#" class="nav-item flex-1 flex flex-col items-center justify-center py-1 transition-colors duration-200" data-page="admin">
                    <i data-lucide="settings" class="w-7 h-7"></i>
                    <span class="text-xs mt-1">Správa</span>
                </a>
            </nav>

            <main style="padding-bottom: 64px;">
                <!-- Page: Dashboard -->
                <div id="page-dashboard">
                    <div class="grid grid-cols-2 grid-rows-4 gap-4 h-full px-2 pt-2 pb-4">
                        <!-- 1. řádek: Obdélník (XP za 7 dní) -->
                        <div class="ui-card col-span-2 flex flex-col justify-center items-center">
                            <p class="text-xs text-gray-400 self-start mb-1">XP za posledních 7 dní</p>
                            <div class="flex-grow w-full flex flex-col items-center justify-center">
                                <canvas id="xp-chart" style="max-width:100%;max-height:70px;"></canvas>
                                <div class="flex w-full justify-between mt-1 px-1 text-[11px] text-gray-400 font-semibold select-none pointer-events-none">
                                    <span>Po</span>
                                    <span>Út</span>
                                    <span>St</span>
                                    <span>Čt</span>
                                    <span>Pá</span>
                                    <span>So</span>
                                    <span>Ne</span>
                                </div>
                            </div>
                        </div>
                        <!-- 2. řádek: 2x Čtverec (Celkové XP & Radar) -->
                        <div class="ui-card flex flex-col items-center justify-center">
                            <p class="text-xs text-gray-400 mb-1">Celkové XP</p>
                            <span id="total-xp-display" class="text-3xl font-extrabold purple-gradient-text flex-grow flex items-center justify-center"></span>
                        </div>
                        <div class="ui-card flex flex-col items-center justify-center">
                            <p class="text-xs text-gray-400 mb-1">Rozložení kategorií</p>
                            <div class="w-full h-full flex-grow flex items-center justify-center">
                                <canvas id="category-radar-chart" style="max-width:100%;max-height:80px;"></canvas>
                            </div>
                        </div>
                        <!-- 3. řádek: Obdélník (Týdenní přehled) -->
                        <div class="ui-card col-span-2 flex flex-col items-center justify-center">
                            <p class="text-xs text-gray-400 self-start mb-1">Týdenní přehled kategorií</p>
                            <div class="flex-grow w-full flex items-center justify-center">
                                <canvas id="weekly-category-barchart" style="max-width:100%;max-height:60px;"></canvas>
                            </div>
                        </div>
                        <!-- 4. řádek: 2x Čtverec (Týdenní cíl & Nejlepší den) -->
                        <div class="ui-card flex flex-col items-center justify-center">
                            <p class="text-xs text-gray-400 mb-1">Týdenní cíl</p>
                            <div class="w-full h-full flex-grow relative flex items-center justify-center">
                                <canvas id="weekly-goal-chart" style="max-width:70px;max-height:70px;"></canvas>
                                <div id="weekly-goal-text" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <span class="text-xl font-bold"></span>
                                </div>
                            </div>
                        </div>
                        <div class="ui-card flex flex-col items-center justify-center">
                            <p class="text-xs text-gray-400 mb-1">Nejlepší den</p>
                            <span id="best-day-xp" class="text-2xl font-bold flex-grow flex items-center justify-center"></span>
                        </div>
                    </div>
                </div>

                <!-- Page: Daily Log -->
                <div id="page-log" class="hidden">
                     <h1 class="text-3xl font-bold mb-6">Denní záznam</h1>
                     <div class="ui-card mb-6">
                        <label for="log-date" class="block text-sm font-medium text-gray-400 mb-2">Datum záznamu</label>
                        <input type="date" id="log-date" class="w-full bg-[#2D3748] border-gray-600 text-white rounded-lg p-3 focus:ring-violet-500 focus:border-violet-500">
                     </div>
                     
                     <div class="space-y-4">
                        <div>
                             <h2 class="text-xl font-semibold mb-3">Dostupné úkoly</h2>
                             <div id="log-tasks-container" class="space-y-3"></div>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold mt-8 mb-3">Dnes zaznamenáno</h2>
                            <div id="logged-today-container" class="space-y-2"></div>
                        </div>
                     </div>
                </div>

                <!-- Page: Admin -->
                <div id="page-admin" class="hidden">
                    <h1 class="text-3xl font-bold mb-6">Správa</h1>
                    <div class="ui-card mb-6">
                        <h2 class="text-xl font-semibold mb-4">Upravit Profil</h2>
                        <form id="edit-profile-form" class="space-y-4">
                            <input type="text" id="profile-nickname" placeholder="Vaše přezdívka" class="w-full bg-[#2D3748] border-gray-600 rounded-lg p-3" required>
                            <button type="submit" class="w-full purple-gradient text-white font-bold py-3 px-4 rounded-lg transition-opacity hover:opacity-90">Uložit přezdívku</button>
                        </form>
                    </div>

                    <div class="ui-card mb-6">
                        <h2 class="text-xl font-semibold mb-4">Přidat nový úkol</h2>
                        <form id="add-task-form" class="space-y-4">
                            <input type="text" id="task-name" placeholder="Název úkolu" class="w-full bg-[#2D3748] border-gray-600 rounded-lg p-3" required>
                            <select id="task-category" class="w-full bg-[#2D3748] border-gray-600 rounded-lg p-3" required>
                                <option value="Mind">Mind</option>
                                <option value="Body">Body</option>
                                <option value="Work">Work</option>
                                <option value="Social">Social</option>
                                <option value="Extra">Extra</option>
                            </select>
                            <input type="number" id="task-xp" placeholder="XP body (+/-)" class="w-full bg-[#2D3748] border-gray-600 rounded-lg p-3" required>
                            <input type="number" id="task-goal" placeholder="Týdenní cíl (např. 5)" class="w-full bg-[#2D3748] border-gray-600 rounded-lg p-3">
                            <button type="submit" class="w-full purple-gradient text-white font-bold py-3 px-4 rounded-lg transition-opacity hover:opacity-90">Přidat úkol</button>
                        </form>
                    </div>
                    
                    <h2 class="text-xl font-semibold mb-4">Seznam úkolů</h2>
                    <div id="admin-tasks-list" class="space-y-3"></div>

                    <!-- Odhlášení tlačítko dole -->
                    <div class="mt-10 flex justify-center">
                        <button id="logout-btn" class="w-full max-w-xs bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200">
                            <i data-lucide="log-out" class="inline-block align-middle mr-2"></i> Odhlásit se
                        </button>
                    </div>
                </div>

                <!-- Page: Statistics -->
                <div id="page-stats" class="hidden">
                    <h1 class="text-3xl font-bold mb-6">Statistiky</h1>
                     <div class="ui-card mb-6">
                        <h2 class="text-lg font-semibold mb-3">Celkové XP podle kategorií</h2>
                        <div class="h-64 flex justify-center items-center">
                            <canvas id="category-pie-chart"></canvas>
                        </div>
                    </div>
                    <div class="ui-card">
                        <h2 class="text-lg font-semibold mb-3">Týdenní aktivita</h2>
                        <div id="heatmap-container" class="grid grid-cols-7 gap-2 text-center text-xs">
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="ui-card w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Opravdu smazat?</h3>
            <p id="modal-text" class="text-gray-400 mb-6">Tuto akci nelze vrátit zpět.</p>
            <div class="flex gap-4">
                <button id="modal-cancel" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Zrušit</button>
                <button id="modal-confirm" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Smazat</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
        <div class="ui-card w-full max-w-md text-center relative">
            <button id="info-modal-close" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors">
                <i data-lucide="x"></i>
            </button>
            <h3 id="info-modal-title" class="text-2xl font-bold mb-4 purple-gradient-text"></h3>
            <p id="info-modal-text" class="text-gray-300 mb-6 whitespace-pre-line leading-relaxed"></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, setDoc, serverTimestamp, writeBatch, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCA4yI3whavL3ig0bXgXEidqe08N_hMcvI",
            authDomain: "lifexp-eaf05.firebaseapp.com",
            projectId: "lifexp-eaf05",
            storageBucket: "lifexp-eaf05.appspot.com",
            messagingSenderId: "1071983930268",
            appId: "1:1071983930268:web:8977284d886c0f5ba03659",
            measurementId: "G-LDFQ52L57B"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE & UI ELEMENTS ---
        let userId = null;
        let userProfile = {};
        let currentPage = 'dashboard';
        let tasks = [];
        let logs = [];
        let xpChart = null;
        let categoryPieChart = null;
        let weeklyGoalChart = null;
        let radarChart = null;
        let weeklyCategoryBarChart = null; // New chart variable
        let confirmCallback = null;

        const pages = {
            dashboard: document.getElementById('page-dashboard'),
            log: document.getElementById('page-log'),
            admin: document.getElementById('page-admin'),
            stats: document.getElementById('page-stats')
        };
        const navItems = document.querySelectorAll('.nav-item');
        const logDateInput = document.getElementById('log-date');
        const confirmationModal = document.getElementById('confirmation-modal');
        const infoModal = document.getElementById('info-modal');

        const categoryColors = {
            Mind: '#34D399', Body: '#F87171', Work: '#60A5FA', Social: '#FBBF24', Extra: '#A78BFA',
        };
        const categoryIcons = {
            Mind: '<i data-lucide="brain-circuit" class="w-6 h-6"></i>', Body: '<i data-lucide="heart-pulse" class="w-6 h-6"></i>', Work: '<i data-lucide="briefcase" class="w-6 h-6"></i>', Social: '<i data-lucide="users" class="w-6 h-6"></i>', Extra: '<i data-lucide="star" class="w-6 h-6"></i>',
        };

        // --- AUTHENTICATION ---
        setPersistence(auth, browserLocalPersistence).catch((err) => {
            console.error("Chyba při nastavování persistence:", err);
        });

        onAuthStateChanged(auth, user => {
            const loadingScreen = document.getElementById('loading-screen');
            const authScreen = document.getElementById('auth-screen');
            const mainContent = document.getElementById('main-content');
            
            if (user) {
                userId = user.uid;
                authScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                loadingScreen.classList.add('hidden');
                initializeAppState();
            } else {
                userId = null;
                loadingScreen.classList.add('hidden');
                authScreen.classList.remove('hidden');
                mainContent.classList.add('hidden');
            }
        });

        // --- AUTH FORMS ---
        function clearAuthErrors() {
            document.getElementById('login-error').textContent = '';
            document.getElementById('register-error').textContent = '';
            document.querySelectorAll('#auth-screen input').forEach(el => el.classList.remove('input-error'));
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAuthErrors();
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            const errorDiv = document.getElementById('login-error');
            
            try {
                await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
            } catch (err) {
                errorDiv.textContent = 'Přihlášení se nezdařilo. Zkontrolujte e-mail a heslo.';
                errorDiv.classList.add('shake');
                emailInput.classList.add('input-error');
                passwordInput.classList.add('input-error');
                setTimeout(() => errorDiv.classList.remove('shake'), 500);
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAuthErrors();
            const emailInput = document.getElementById('register-email');
            const passwordInput = document.getElementById('register-password');
            const confirmPasswordInput = document.getElementById('register-password-confirm');
            const errorDiv = document.getElementById('register-error');

            if (passwordInput.value !== confirmPasswordInput.value) {
                errorDiv.textContent = 'Hesla se neshodují.';
                errorDiv.classList.add('shake');
                passwordInput.classList.add('input-error');
                confirmPasswordInput.classList.add('input-error');
                setTimeout(() => errorDiv.classList.remove('shake'), 500);
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
            } catch (err) {
                let msg = 'Registrace se nezdařila. ';
                if (err.code === 'auth/email-already-in-use') {
                    msg = 'Tento e-mail je již registrován.';
                    emailInput.classList.add('input-error');
                } else if (err.code === 'auth/invalid-email') {
                    msg = 'Zadejte prosím platný e-mail.';
                    emailInput.classList.add('input-error');
                } else if (err.code === 'auth/weak-password') {
                    msg = 'Heslo musí mít alespoň 6 znaků.';
                    passwordInput.classList.add('input-error');
                    confirmPasswordInput.classList.add('input-error');
                } else {
                    msg += 'Zkontrolujte zadané údaje.';
                    emailInput.classList.add('input-error');
                    passwordInput.classList.add('input-error');
                }
                errorDiv.textContent = msg;
                errorDiv.classList.add('shake');
                setTimeout(() => errorDiv.classList.remove('shake'), 500);
            }
        });
        
        // --- AUTH VIEW TOGGLING ---
        document.getElementById('show-register-view').addEventListener('click', (e) => {
            e.preventDefault();
            clearAuthErrors();
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('register-view').classList.remove('hidden');
        });

        document.getElementById('show-login-view').addEventListener('click', (e) => {
            e.preventDefault();
            clearAuthErrors();
            document.getElementById('register-view').classList.add('hidden');
            document.getElementById('login-view').classList.remove('hidden');
        });

        // --- PASSWORD VISIBILITY TOGGLE ---
        document.querySelectorAll('.password-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                const targetId = toggle.dataset.target;
                const passwordInput = document.getElementById(targetId);
                if (passwordInput) {
                    const isPassword = passwordInput.type === 'password';
                    passwordInput.type = isPassword ? 'text' : 'password';
                    toggle.innerHTML = `<i data-lucide="${isPassword ? 'eye-off' : 'eye'}" class="w-5 h-5"></i>`;
                    toggle.classList.toggle('text-violet-400', isPassword);
                    if (window.lucide) window.lucide.createIcons();
                }
            });
        });

        // --- INITIALIZATION ---
        function initializeAppState() {
            lucide.createIcons();
            setupEventListeners();
            navigateTo('dashboard');
            logDateInput.value = new Date().toISOString().split('T')[0];
            listenForProfile();
            listenForTasks();
            listenForLogs();
            checkWeeklySummary();
        }

        // --- NAVIGATION ---
        function navigateTo(pageId) {
            currentPage = pageId;
            Object.values(pages).forEach(p => p.classList.add('hidden'));
            pages[pageId].classList.remove('hidden');
            navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
            
            const mainEl = document.querySelector('main');
            if (pageId === 'dashboard') {
                mainEl.style.overflowY = 'hidden';
            } else {
                mainEl.style.overflowY = 'auto';
            }

            renderPageContent();
        }

        // --- DATA LISTENERS (REAL-TIME UPDATES) ---
        function listenForProfile() {
            if(!userId) return;
            const profileDocRef = doc(db, 'users', userId, 'profile', 'data');
            onSnapshot(profileDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                } else {
                    setDoc(profileDocRef, { nickname: 'Nováček', lastWeeklySummary: '' });
                    userProfile = { nickname: 'Nováček', lastWeeklySummary: '' };
                }
                document.getElementById('profile-nickname').value = userProfile.nickname || '';
            }, (error) => {
                console.error("Chyba při načítání profilu:", error);
            });
        }

        function listenForTasks() {
            if (!userId) return;
            const tasksCollection = collection(db, 'users', userId, 'tasks');
            onSnapshot(tasksCollection, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.name.localeCompare(b.name));
                renderPageContent();
            }, (error) => {
                console.error("Chyba při načítání úkolů:", error);
            });
        }

        function listenForLogs() {
            if (!userId) return;
            const logsCollection = collection(db, 'users', userId, 'logs');
            onSnapshot(logsCollection, (snapshot) => {
                logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPageContent();
            }, (error) => {
                console.error("Chyba při načítání záznamů:", error);
            });
        }

        // --- RENDERING LOGIC ---
        function renderPageContent() {
            if (!userId) return;
            switch (currentPage) {
                case 'dashboard': renderDashboard(); break;
                case 'log': renderLogPage(); break;
                case 'admin': renderAdminPage(); break;
                case 'stats': renderStatsPage(); break;
            }
            lucide.createIcons();
        }
        
        function renderDashboard() {
            const totalXpEl = document.getElementById('total-xp-display');
            const currentXp = parseInt(totalXpEl.dataset.currentValue || '0', 10);
            const totalXp = logs.reduce((sum, log) => sum + log.xp, 0);
            animateValue(totalXpEl, currentXp, totalXp, 600);
            totalXpEl.dataset.currentValue = totalXp;

            const dailyXp = logs.reduce((acc, log) => {
                acc[log.date] = (acc[log.date] || 0) + log.xp;
                return acc;
            }, {});
            let bestDay = { date: '-', xp: 0 };
            for (const [date, xp] of Object.entries(dailyXp)) {
                if (xp > bestDay.xp) {
                    bestDay = { date, xp };
                }
            }
            document.getElementById('best-day-xp').textContent = bestDay.xp > 0 ? `${bestDay.xp} XP` : 'Žádná data';

            renderXpChart();
            renderWeeklyGoalChart();
            renderCategoryRadarChart();
            renderWeeklyCategoryBarChart(); // New chart render call
        }

        function renderCategoryRadarChart() {
            const ctx = document.getElementById('category-radar-chart').getContext('2d');
            const positiveLogs = logs.filter(l => l.xp > 0);
            const data = Object.keys(categoryColors).map(cat =>
                positiveLogs.filter(l => l.category === cat).reduce((sum, l) => sum + l.xp, 0)
            );
            if (window.radarChart) window.radarChart.destroy();
            window.radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(categoryColors),
                    datasets: [{
                        data: data,
                        backgroundColor: 'rgba(167,139,250,0.18)',
                        borderColor: '#A78BFA',
                        borderWidth: 2,
                        pointBackgroundColor: Object.values(categoryColors),
                        pointRadius: 2,
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    animation: { duration: 600, easing: 'easeOutQuart' },
                    scales: {
                        r: {
                            angleLines: { color: '#2D3748' },
                            grid: { color: '#2D3748' },
                            pointLabels: { color: '#C4B5FD', font: { size: 10, weight: 'bold' } },
                            ticks: { display: false, stepSize: Math.max(...data) > 0 ? Math.max(...data) / 2 : 1 }
                        }
                    }
                }
            });
        }

        function renderWeeklyGoalChart() {
            const ctx = document.getElementById('weekly-goal-chart').getContext('2d');
            const tasksWithGoals = tasks.filter(t => t.goalFrequency > 0);
            const textEl = document.getElementById('weekly-goal-text').firstElementChild;
            if (tasksWithGoals.length === 0) {
                textEl.textContent = 'Žádné cíle';
                if (window.weeklyGoalChart) window.weeklyGoalChart.destroy();
                return;
            }
            const totalGoal = tasksWithGoals.reduce((sum, t) => sum + t.goalFrequency, 0);
            const { start } = getWeekDateRange(new Date());
            const startOfWeekString = start.toISOString().split('T')[0];
            
            const thisWeekLogs = logs.filter(l => {
                const task = tasks.find(t => t.id === l.taskId);
                return l.date >= startOfWeekString && task && task.goalFrequency > 0;
            });

            const completedCount = thisWeekLogs.length;
            const percentage = totalGoal > 0 ? Math.min(100, Math.round((completedCount / totalGoal) * 100)) : 0;
            textEl.textContent = `${percentage}%`;

            if (window.weeklyGoalChart) window.weeklyGoalChart.destroy();
            window.weeklyGoalChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [completedCount, Math.max(0, totalGoal - completedCount)],
                        backgroundColor: ['#A78BFA', '#2D3748'],
                        borderColor: '#1A1C20', borderWidth: 3, borderRadius: 6, cutout: '80%',
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });
        }

        function renderXpChart() {
            const ctx = document.getElementById('xp-chart').getContext('2d');
            // Days of week in Czech, starting Monday
            const dayLabels = ['Po', 'Út', 'St', 'Čt', 'Pá', 'So', 'Ne'];
            const labels = [...Array(7)].map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                return d;
            });
            const data = labels.map(date => {
                const dateString = date.toISOString().split('T')[0];
                return logs
                    .filter(log => log.date === dateString)
                    .reduce((sum, log) => sum + log.xp, 0);
            });
            if (window.xpChart) window.xpChart.destroy();
            const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.clientHeight);
            gradient.addColorStop(0, 'rgba(167, 139, 250, 0.5)');
            gradient.addColorStop(1, 'rgba(167, 139, 250, 0)');
            window.xpChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: 'XP',
                        data: data,
                        borderColor: '#A78BFA',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#A78BFA',
                        pointBorderColor: '#A78BFA',
                        pointRadius: 3,
                        pointHoverRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: {
                            display: false // labels are shown below the chart as custom HTML
                        },
                        y: { display: false }
                    }
                }
            });
        }

        // New function for the weekly category bar chart
        function renderWeeklyCategoryBarChart() {
            const ctx = document.getElementById('weekly-category-barchart')?.getContext('2d');
            if (!ctx) return;

            const { start } = getWeekDateRange(new Date());
            const startOfWeekString = start.toISOString().split('T')[0];
            
            const thisWeekLogs = logs.filter(l => l.date >= startOfWeekString && l.xp > 0);

            const data = Object.keys(categoryColors).map(cat =>
                thisWeekLogs.filter(l => l.category === cat).reduce((sum, l) => sum + l.xp, 0)
            );
            const labels = Object.keys(categoryColors);

            if (window.weeklyCategoryBarChart) {
                window.weeklyCategoryBarChart.destroy();
            }

            window.weeklyCategoryBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: Object.values(categoryColors),
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Horizontal bars
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                borderColor: 'transparent'
                            },
                            ticks: {
                                color: '#9CA3AF',
                                font: { size: 10 }
                            }
                        },
                        y: {
                            grid: {
                                display: false,
                                borderColor: 'transparent'
                            },
                            ticks: {
                                color: '#9CA3AF',
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }
        
        function renderLogPage() {
            const selectedDate = logDateInput.value;
            const tasksContainer = document.getElementById('log-tasks-container');
            const loggedTodayContainer = document.getElementById('logged-today-container');
            
            tasksContainer.innerHTML = '';
            loggedTodayContainer.innerHTML = '';

            const loggedTaskIdsForDate = logs.filter(l => l.date === selectedDate).map(l => l.taskId);

            tasks.forEach(task => {
                const isLogged = loggedTaskIdsForDate.includes(task.id);
                const taskEl = document.createElement('div');
                taskEl.className = `flex items-center justify-between p-4 rounded-xl transition-all duration-200 ${isLogged ? 'bg-green-500/20' : 'bg-[#2D3748]'}`;
                taskEl.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div style="color: ${categoryColors[task.category]}">${categoryIcons[task.category]}</div>
                        <div>
                            <p class="font-semibold text-white">${task.name}</p>
                            <p class="text-sm ${task.xp > 0 ? 'text-green-400' : 'text-red-400'}">${task.xp > 0 ? '+' : ''}${task.xp} XP</p>
                        </div>
                    </div>
                    <button data-task-id="${task.id}" class="log-task-btn p-2 rounded-full ${isLogged ? 'bg-gray-600' : 'purple-gradient'}">
                        <i data-lucide="${isLogged ? 'rotate-ccw' : 'plus'}" class="w-6 h-6 text-white"></i>
                    </button>
                `;
                tasksContainer.appendChild(taskEl);
            });

            const logsForDate = logs.filter(l => l.date === selectedDate);
            if (logsForDate.length === 0) {
                loggedTodayContainer.innerHTML = '<p class="text-gray-500 text-center">Dnes zatím žádné záznamy.</p>';
            } else {
                logsForDate.forEach(log => {
                    const task = tasks.find(t => t.id === log.taskId);
                    const logEl = document.createElement('div');
                    logEl.className = 'flex items-center justify-between bg-[#1A1C20] p-3 rounded-lg';
                    logEl.innerHTML = `
                        <p>${task ? task.name : 'Smazaný úkol'}</p>
                        <span class="font-bold ${log.xp > 0 ? 'text-green-400' : 'text-red-400'}">${log.xp > 0 ? '+' : ''}${log.xp} XP</span>
                    `;
                    loggedTodayContainer.appendChild(logEl);
                });
            }
        }

        function renderAdminPage() {
            const tasksList = document.getElementById('admin-tasks-list');
            tasksList.innerHTML = '';
            if (tasks.length === 0) {
                tasksList.innerHTML = '<p class="text-gray-500 text-center">Zatím nebyly přidány žádné úkoly.</p>';
                return;
            }
            tasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'flex items-center justify-between bg-[#2D3748] p-4 rounded-xl';
                taskEl.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div style="color: ${categoryColors[task.category]}">${categoryIcons[task.category]}</div>
                        <div>
                            <p class="font-semibold">${task.name}</p>
                            <p class="text-sm text-gray-400">Cíl: ${task.goalFrequency > 0 ? `${task.goalFrequency}x týdně` : 'Není'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold ${task.xp > 0 ? 'text-green-400' : 'text-red-400'}">${task.xp > 0 ? '+' : ''}${task.xp} XP</span>
                        <button data-task-id="${task.id}" class="delete-task-btn p-2 text-gray-400 hover:text-red-400 transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                tasksList.appendChild(taskEl);
            });
        }

        function renderStatsPage() {
            renderCategoryPieChart();
            renderHeatmap();
        }

        function renderCategoryPieChart() {
            const ctx = document.getElementById('category-pie-chart').getContext('2d');
            const positiveLogs = logs.filter(l => l.xp > 0);
            const data = Object.keys(categoryColors).map(cat => 
                positiveLogs.filter(l => l.category === cat).reduce((sum, l) => sum + l.xp, 0)
            );
            
            if(window.categoryPieChart) window.categoryPieChart.destroy();
            window.categoryPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryColors),
                    datasets: [{
                        data: data,
                        backgroundColor: Object.values(categoryColors),
                        borderColor: '#1A1C20',
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#9CA3AF', font: { size: 12 } }
                        }
                    }
                }
            });
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmap-container');
            container.innerHTML = '';
            const days = ['Ne', 'Po', 'Út', 'St', 'Čt', 'Pá', 'So'];
            days.forEach(day => container.innerHTML += `<div class="font-bold text-gray-500">${day}</div>`);
            
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 34); // Approx 5 weeks
            
            const dailyXp = logs.reduce((acc, log) => {
                acc[log.date] = (acc[log.date] || 0) + log.xp;
                return acc;
            }, {});

            const maxXP = Math.max(...Object.values(dailyXp), 1);

            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateString = d.toISOString().split('T')[0];
                const xp = dailyXp[dateString] || 0;
                const intensity = xp > 0 ? Math.min(1, xp / (maxXP * 0.75)) : 0;
                const color = `rgba(167, 139, 250, ${intensity})`;
                
                const dayEl = document.createElement('div');
                dayEl.className = 'w-full aspect-square rounded-md flex items-center justify-center';
                dayEl.style.backgroundColor = color;
                dayEl.title = `${dateString}: ${xp} XP`;
                container.appendChild(dayEl);
            }
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(item.dataset.page);
                });
            });

            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            
            document.getElementById('add-task-form').addEventListener('submit', handleAddTask);
            document.getElementById('edit-profile-form').addEventListener('submit', handleEditProfile);
            
            document.getElementById('admin-tasks-list').addEventListener('click', e => {
                if (e.target.closest('.delete-task-btn')) {
                    const taskId = e.target.closest('.delete-task-btn').dataset.taskId;
                    showConfirmationModal('Smazat úkol?', 'Opravdu chcete smazat tento úkol a všechny jeho záznamy? Tuto akci nelze vrátit.', () => handleDeleteTask(taskId));
                }
            });

            logDateInput.addEventListener('change', renderLogPage);

            document.getElementById('log-tasks-container').addEventListener('click', async e => {
                const button = e.target.closest('.log-task-btn');
                if (button) {
                    const taskId = button.dataset.taskId;
                    const selectedDate = logDateInput.value;
                    const existingLog = logs.find(l => l.date === selectedDate && l.taskId === taskId);
                    
                    if (existingLog) {
                        await deleteDoc(doc(db, 'users', userId, 'logs', existingLog.id));
                    } else {
                        const task = tasks.find(t => t.id === taskId);
                        if (task) {
                            await addDoc(collection(db, 'users', userId, 'logs'), {
                                taskId: task.id,
                                date: selectedDate,
                                xp: task.xp,
                                category: task.category,
                                timestamp: serverTimestamp()
                            });
                        }
                    }
                }
            });

            // Modal listeners
            document.getElementById('modal-cancel').addEventListener('click', hideConfirmationModal);
            document.getElementById('info-modal-close').addEventListener('click', hideInfoModal);
            document.getElementById('modal-confirm').addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                hideConfirmationModal();
            });
        }
        
        // --- ACTION HANDLERS ---
        async function handleAddTask(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#task-name').value.trim();
            const category = form.querySelector('#task-category').value;
            const xp = parseInt(form.querySelector('#task-xp').value, 10);
            const goalFrequency = parseInt(form.querySelector('#task-goal').value, 10) || 0;

            if (name && !isNaN(xp)) {
                await addDoc(collection(db, 'users', userId, 'tasks'), {
                    name, category, xp, goalFrequency,
                    createdAt: serverTimestamp()
                });
                form.reset();
            }
        }

        async function handleEditProfile(e) {
            e.preventDefault();
            const nickname = document.getElementById('profile-nickname').value.trim();
            if (nickname) {
                const profileDocRef = doc(db, 'users', userId, 'profile', 'data');
                await setDoc(profileDocRef, { nickname }, { merge: true });
                showInfoModal('Profil uložen', 'Vaše přezdívka byla úspěšně aktualizována.');
            }
        }

        async function handleDeleteTask(taskId) {
            if (!userId || !taskId) return;
            const batch = writeBatch(db);
            // Delete the task
            const taskRef = doc(db, 'users', userId, 'tasks', taskId);
            batch.delete(taskRef);
            // Delete all logs associated with the task
            const logsQuery = query(collection(db, 'users', userId, 'logs'), where("taskId", "==", taskId));
            const logsSnapshot = await getDocs(logsQuery);
            logsSnapshot.forEach(logDoc => {
                batch.delete(logDoc.ref);
            });
            await batch.commit();
        }

        // --- MODALS ---
        function showConfirmationModal(title, text, callback) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            confirmCallback = callback;
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        }

        function showInfoModal(title, text) {
            document.getElementById('info-modal-title').textContent = title;
            document.getElementById('info-modal-text').textContent = text;
            infoModal.classList.remove('hidden');
        }

        function hideInfoModal() {
            infoModal.classList.add('hidden');
        }

        // --- UTILITY FUNCTIONS ---
        function getWeekDateRange(date) {
            const start = new Date(date);
            const day = start.getDay();
            const diff = start.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            start.setDate(diff);
            start.setHours(0, 0, 0, 0);

            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            end.setHours(23, 59, 59, 999);
            
            return { start, end };
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString('cs-CZ');
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        async function checkWeeklySummary() {
            const today = new Date();
            // Check on Monday
            if (today.getDay() !== 1) return;

            const { start } = getWeekDateRange(today);
            const weekId = `${start.getFullYear()}-${start.getMonth()}-${start.getDate()}`;
            
            if (userProfile.lastWeeklySummary === weekId) return;

            const lastWeek = new Date(today);
            lastWeek.setDate(today.getDate() - 7);
            const { start: lastWeekStart, end: lastWeekEnd } = getWeekDateRange(lastWeek);
            
            const lastWeekLogs = logs.filter(l => l.date >= lastWeekStart.toISOString().split('T')[0] && l.date <= lastWeekEnd.toISOString().split('T')[0]);
            
            if (lastWeekLogs.length > 0) {
                const totalXp = lastWeekLogs.reduce((sum, l) => sum + l.xp, 0);
                const tasksCompleted = lastWeekLogs.length;
                const categories = [...new Set(lastWeekLogs.map(l => l.category))];

                let summaryText = `Minulý týden jsi získal(a) ${totalXp} XP!\n`;
                summaryText += `Dokončil(a) jsi ${tasksCompleted} úkolů.\n`;
                summaryText += `Nejvíce jsi se zaměřil(a) na kategorie: ${categories.join(', ')}.\n\nJen tak dál!`;
                
                showInfoModal('Týdenní shrnutí', summaryText);
            }

            const profileDocRef = doc(db, 'users', userId, 'profile', 'data');
            await setDoc(profileDocRef, { lastWeeklySummary: weekId }, { merge: true });
        }
        
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(err => {
                        console.error('Service Worker registration failed:', err);
                    });
            });
        }
    </script>

</body>
</html>
